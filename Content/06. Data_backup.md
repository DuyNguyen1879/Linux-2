# Data Backup

## Rsync ( Remote Sync)

[I. Overview](#overview)</br>
[II. Install](#install)</br>
[III. Config](#config)</br>

<a name="overview"></a>
## I. Overview</br>
Rsync là một công cụ cho phép truyền và đồng bộ file, thư mục từ xa giữa các máy tính một cách dễ dàng.</br>
Hoạt động trên Windowns, Mac OS và GNU/Linux.</br>
Lệnh `rsync` được sử dụng để đồng bộ hóa toàn bộ cây thư mục. Về cơ bản, nó sao chép tập tin như lệnh `cp`. Ngoài ra, `rsync` sẽ kiểm tra xem tệp đã được sao chép đã tồn tại chưa. Nếu tệp tồn tại và không có thay đổi về kích thước hoặc thời gian sửa đổi, `rsync` sẽ tránh một bản sao không cần thiết và tiết kiệm thời gian. Hơn nữa, với thuật toán delta-copy, `rsync` chỉ copy những phần thay đổi, làm giảm được dữ liệu qua mạng, và nó có thể kiểm soát được băng thông cần thiết cho việc truyền tin nên nó có thể rất nhanh.</br>
`rsync` là rất hiệu quả khi đệ quy sao chép một cây thư mục thông qua mạng, bởi vì chỉ có sự khác biệt được truyền đi. Người ta thường đồng bộ hóa cây thư mục đích với gốc, sử dụng tùy chọn `rsync -r` để đệ quy đi xuống cây thư mục sao chép tất cả các tệp và thư mục bên dưới thư mục được liệt kê dưới dạng nguồn.

### 1. Một số các đặc điểm</br>
Mặc định `rsync` copy theo dạng block (nhưng vẫn có tùy chọn copy theo dạng file) nên tốc độ đồng bộ được cải thiện nhiều khi làm việc với file và thư mục có kích thước lớn.
`rsync` cho phép nén dữ liệu để giảm thiểu việc sử dụng băng thông. Nhưng nó cũng tốn thêm một khoảng thời gian cho việc nén và giải nén dữ liệu.</br>
Mặc định sử dụng `ssh` trên hầu hết các hệ thống để mã hóa dữ liệu và bảo mật.
Đặc biệt là `rsync` copy và giữ nguyên các thông số về file và folder như: `Symbolic links`, `Permissions`, `TimeStamp`, `Owner` và `Group`.</br>
Không yêu cầu quyền super-user

### 2. Các chế độ</br>
`rsync` có hai mode, một là `remote-shell` dùng lệnh copy bình thường (ssh, rsh), 2 là chạy `daemon` qua TCP.</br>
Mode `daemon` mặc định bind đến cổng 873, ở chế độ này, `rsync` hoạt động giống như một `ftp server` và cho phép download file public

### 3. Cơ chế hoạt động</br>
`rsync` tìm kiếm files cần được transfer, sử dụng `lqquick checkrq algorithm` (mặc định) để tìm các file có thay đổi về kích thước hoặc lần sử đổi cuối cùng (last-modified time). Bất kỳ một sự thay đổi nào về các thuộc tính thì sẽ được thực hiện trực tiếp luôn trên tệp đích khi kiểm tra sự thay đổi của dữ liệu file mà không cần phải update

<a name="install"></a>
## II. Install Rsync on Linux

### 1. Với Ubuntu/Debian:
```sh
apt-get install rsync
Với Red Hat/CentOS
```
```sh
yum install rsync
```
### 2. Sử dụng

Cấu trúc câu lệnh cơ bản
```sh
rsync [options] source destination
```
Trong đó: * Source(src): Đường dẫn tới dữ liệu nguồn * Destination(dest): Đường dẫn tới đích * Options: một số tùy chọn khác

Local:

rsync rsync [options] source [destination]
Access via remote shell:

Pull: rsync [option] [user@]host:src [dest]
Push: rsync [option] src [user@]host:dest
Access via rsync daemon:

Pull:   rsync [option] [user@]host::src [dest]
	rsync [option] rsync://[user@]host[:port]/src. [dest]
Push:   rsync [option] src [user@]host::dest
        rsync [option] src rsync://[user@]host[:port]/dest
Các Option:
-v mặc định rsync làm việc rất im lặng, với -v sẽ cho bạn thông tin về file đang được truyền và kết quả cuối cùng
-c --checksum Tạo checksum trước khi gửi và kiểm tra sau khi nhận
-a --archive Copy dữ liệu recursively và giữ nguyên được tất cả các thông số của file và thư mục
-r Cũng là copy dữ liệu recursively nhưng không đảm bảo về các thông số trên
-z nén dữ liệu trước khi truyền đi
--delete: Xóa dữ liệu không liên quan ở Dest nếu Source không tồn tại dữ liệu đó
-u: không ghi đè dữ liệu ở thư mục đích
--exclude: trừ những dữ liệu không muốn truyền đi
Ví dụ
2.1 Copy file và thư mục trên local
rsync -zvh backup.tar /tmp/backups/
2.2 Copy file và thư mục giữa các server
Đẩy từ local lên server

rsync -avz rpmpkgs/ root@192.168.0.101:/home/
Download từ server về local

rsync -avzh root@192.168.0.100:/home/tarunika/rpmpkgs /tmp/myrpms
2.3 Rsync qua ssh
Download file từ Remote Server về Local Server

rsync -avzhe ssh root@192.168.0.100:/root/install.log /tmp/
Đẩy file lên Server

rsync -avzhe ssh backup.tar root@192.168.0.100:/backups/
2.4 Sử dụng tùy chọn --include --exclude
rsync -avze ssh --include 'R*' --exclude '*' root@192.168.0.101:/var/lib/rpm/ /root/rpm

3. Config
Cấu hình đồng bộ giữa hai máy client và server

Client

ip: 192.168.60.134
OS: Ubuntu 16.04
Server

ip: 192.168.60.130
OS: Ubuntu 16.04
Các bước cấu hình:

Cài đặt rsync trên cả client và server
apt-get install xinetd rsync
Cài đặt và cấu hình ban đầu
Trên server
Sửa file sudo vi /etc/default/rsync, sử dùng như dòng dưới đây từ false thành true

RSYNC_ENABLE=true

/etc/init.d/rsync start

Tạo file /etc/rsync.conf với nội dung như sau

lock file = /var/run/rsync.lock log file = /var/log/rsyncd.log pid file = /var/run/rsyncd.pid

[data] path = /data uid = root gid = root read only = no hosts allow = 192.168.60.134/255.255.255.0

Lưu dữ liệu được đồng bộ từ client lên tại /data

Chạy Rsync /etc/init.d/rsync start
Trên client
Test thử xem kết nối được tới server được chưa. Chạy lệnh với một số các tùy chọn sau: rsync -avz --progress /home/trang/test/ rsync://root@192.168.60.130/data

root@ubuntu:/home/trang/test# rsync -avz --progress /home/trang/test/ rsync://root@192.168.60.130/data
sending incremental file list
./
file2.txt
    	      0 100%    0.00kB/s    0:00:00 (xfr#1, to-chk=3/5)
file3.txt
    	      0 100%    0.00kB/s    0:00:00 (xfr#2, to-chk=2/5)
file/
file/file4.txt
    	      0 100%    0.00kB/s    0:00:00 (xfr#3, to-chk=0/5)

sent 270 bytes  received 88 bytes  716.00 bytes/sec
total size is 0  speedup is 0.00
files và floder sẽ được đồng bộ trong /data của server

Sử dụng incrond để check và đồng bộ real time
** Trên client **

Cài incron
RHEL/Fedora/CentOS

$ sudo yum install incron
Debian/Ubuntu

$ sudo apt-get install incron
Sửa file /etc/incron.allow thêm user root hoặc một user khác được phép sử dung incrond

root trangnth

incrontab -e thêm dòng sau

/home/trang/test/ IN_CLOSE_WRITE,IN_CREATE,IN_DELETE rsync -avz --progress /home/trang/test/ rsync://root@192.168.60.130/data

Mỗi khi có sự thay đổi như thêm, xóa file, sửa file trong /home/trang/test sẽ được đồng bộ với server

Xem log vim /var/log/system



```sh
# rsync -ravzh project_ABC /data/backups
sending incremental file list
project_ABC/
project_ABC/file1.txt
project_ABC/file2.txt
project_ABC/file3.txt
project_ABC/file4.txt

sent 636 bytes  received 92 bytes  1.46K bytes/sec
total size is 452  speedup is 0.62
```

# Compress data

Dữ liệu tệp thường được nén để tiết kiệm dung lượng đĩa và giảm thời gian cần để truyền tệp qua mạng. Linux sử dụng một số phương pháp để thực hiện nén này.

|Command|Usage|
|-------|-----|
|gzip|Sử dụng thường xuyên trong Linux|
|bzip2|Tạo ra các tệp nhỏ hơn nhiều so với các tệp được tạo bởi gzip|
|xz|Tiện ích nén hiệu quả nhất về không gian được sử dụng trong Linux. Nó hiện đang được sử dụng bởi kernel.org để lưu trữ lưu trữ của Linux kernel.|
|zip|Thường được yêu cầu để kiểm tra và giải nén lưu trữ từ các hệ điều hành khác|

Những kỹ thuật này khác nhau về hiệu quả nén (không gian được lưu trữ) và thời gian nén; nói chung các kỹ thuật hiệu quả hơn mất nhiều thời gian hơn. Thời gian giải nén không thay đổi nhiều so với các phương thức khác nhau.</br>
# Lưu trữ dữ liệu</br>
Lệnh `tar` cho phép bạn tạo hoặc giải nén các tệp từ một tệp lưu trữ, thường được gọi là `tarball`. Đồng thời, bạn có thể tùy chọn nén trong khi tạo lưu trữ và giải nén trong khi trích xuất nội dung của nó.</br>
Dưới đây là một số ví dụ về việc sử dụng `tar`:

|Command|Usage|
|-------|-----|
|tar xvf mydir.tar|Giải nén tất cả các tệp trong mydir.tar vào thư mục mydir|
|tar zcvf mydir.tar.gz mydir|Tạo lưu trữ và nén bằng `gzip`|
|tar jcvf mydir.tar.bz2 mydir|Tạo lưu trữ và nén với `bz2`|
|tar xvf mydir.tar.gz|Giải nén tất cả các tệp trong mydir.tar.gz vào thư mục mydir|
|tar cvf mydir.tar|Hiển thị nội dung trong thư mục mydir|

# Copying disks</br>
Lệnh `dd` rất hữu ích để tạo bản sao của không gian đĩa thô. Ví dụ: để sao lưu Master Boot Record(MBR) (512 byte sector đầu tiên trên đĩa có chứa một bảng mô tả các phân vùng trên đĩa đó), sử dụng:</br>
```sh
# dd if=/dev/sda of=sda.mbr bs=512 count=1
```
Để sử dụng `dd` để sao chép một đĩa vào một đĩa khác, xóa mọi thứ đã tồn tại trên đĩa thứ hai, hãy sử dụng:
```sh
# dd if=/dev/sda of=/dev/sdb
```
Bản sao chính xác của thiết bị đĩa đầu tiên được tạo trên thiết bị đĩa thứ hai.</br>
Lệnh `dd` có ích khi sao chép đĩa bootable như một thẻ Compact Flash, thẻ Micro SD hoặc khóa USB có thể khởi động. Chèn thẻ CF được sao chép vào hệ thống và tạo một bản sao</br>
```sh
# dd if=/dev/sdb of=./backup.img
```
Remove thẻ CF, chèn thẻ mới và tạo bản sao mới</br>
```sh
# dd if=./backup.img of=/dev/sdc
```
