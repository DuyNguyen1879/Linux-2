# Linux processes</br>
Một `processes` đơn giản là một thể hiện của một hay nhiều luồng(threads) liên quan được thực hiện trên cùng một máy. Nó không giống như một chương trình hoặc một lệnh; một chương trình duy nhất thực sự có thể bắt đầu một số tiến trình cùng một lúc. Một số tiến trình độc lập với nhau và những quy trình khác có liên quan. Lỗi của một tiến trình có thể hoặc không thể ảnh hưởng đến các tiến trình khác đang chạy trên hệ thống. Các tiến trình sử dụng nhiều tài nguyên hệ thống, như bộ nhớ, CPU và các thiết bị ngoại vi như máy in và màn hình. Hệ điều hành(đặc biệt là kernel) chịu trách nhiệm phân bổ một phần thích hợp các tài nguyên này cho mỗi tiến trình và đảm bảo sử dụng tối ưu tổng thể.</br>
Một terminal window là một tiến trình chạy miễn là cần thiết. Nó cho phép người dùng thực thi các chương trình và truy cập tài nguyên trong môi trường tương tác. Bạn cũng có thể chạy các chương trình trong nền, điều đó có nghĩa là chúng bị tách ra khỏi shell. Các tiến  trình có thể có nhiều loại khác nhau tùy theo nhiệm vụ đang được thực hiện.

|Type|Description|
|----|-----------|
|Interactive|Cần phải được bắt đầu bởi người dùng, tại một dòng lệnh hoặc thông qua giao diện đồ họa như biểu tượng hoặc lựa chọn menu.|
|Batch|Các tiến trình tự động được lên lịch từ đó và sau đó ngắt kết nối khỏi thiết bị đầu cuối. Các tác vụ này được xếp hàng và hoạt động trên cơ sở FIFO (First In, First Out).|
|Daemons|Tiến trình máy chủ chạy liên tục. Nhiều thứ được khởi chạy trong quá trình khởi động hệ thống và sau đó chờ người dùng hoặc yêu cầu hệ thống chỉ ra rằng dịch vụ của họ là bắt buộc.|
|Threads|Các tiến trình nhẹ. Đây là các tác vụ chạy dưới tiến trình chính, chia sẻ bộ nhớ và các tài nguyên khác, nhưng được hệ thống lên lịch và chạy trên cơ sở cá nhân.|
|Kernel Threads|Các tác vụ Kernel mà người dùng không bắt đầu cũng không chấm dứt và có ít quyền kiểm soát. Chúng có thể thực hiện các hành động như di chuyển một luồng từ CPU này sang CPU khác hoặc đảm bảo các hoạt động input/output vào đĩa được hoàn thành.|



Hệ điều hành sẽ theo dõi các tiến trình thông qua một ID có 5 chứ số mà được biết như là pid hay process ID. Mỗi tiến trình có duy nhất một pid.

Tại cùng một lúc không thể có 2 tiến trình có cùng pid.

Khi bạn bắt đầu một tiến trình (đơn giản là chạy một lệnh), có 2 các để chạy nó:
* Foreground Process: Mặc định khi bắt đầu các tiến trình là Foreground, nhận input từ bàn phím và output tới màn hình. Trong khi chương trình chạy thì không thể chạy bất cứ tiến trình nào khác
* Background Process: chạy mà không kết nối với bàn phím của bạn. Lợi thế là khi đó đang chạy tiến trình background vẫn có thể chạy các tiến trình khác.

Để bắt đầu một tiến trình Background thì thêm dấu `&` vào cuối câu lệnh ví dụ

`$ ls &`

ở đây lệnh `ls` muốn có một đầu vào, nó tiến vào trạng thái dừng tới khi bạn chuyển nó vào trong foreground.

Liệt kê các tiến trình đang chạy

```sh
$ ps
  PID TTY          TIME CMD
 6085 pts/1    00:00:00 bash
 6116 pts/1    00:00:00 ps
$ ps -f
UID        PID  PPID  C STIME TTY          TIME CMD
ubuntu    6085  6084  0 08:58 pts/1    00:00:00 -bash
ubuntu    6117  6085  0 09:03 pts/1    00:00:00 ps -f
```

Trong đó:

|Thông số|Miêu tả|
|--|--|
|UID	|ID người sử dụng mà tiến trình này thuộc sở hữu (người chạy nó).|
|PID	|Process ID.|
|PPID	|Process ID gốc (ID của tiến trình mà bắt đầu nó).|
|C	|CPU sử dụng của tiến trình.|
|STIME	|Thời gian bắt đầu tiến trình.|
|TTY	|Kiểu terminal liên kết với tiến trình.|
|TIME	|Thời gian CPU bị sử dụng bởi tiến trình.|
|CMD	|Lệnh mà bắt đầu tiến trình này.|

Một số lệnh với `ps`: 

* `ps -ef` – Liệt kê process đang chạy bây giờ. (Một command tương tự là ps aux)
* `ps -f -u user1,user2` – Sẽ hiển thị tất cả process dựa rên UID (user id hoặc username).
* `ps -f –pid ID` – Hiển thị tất cả processes dựa trên process ID (pid). Điền PID hoặc PPID thay vào chỗ id. Có thể được dùng với PPID để lọc process dựa trên parent ID.
* `ps -C command/name` – Lọc Processes dựa trên tên của nó hoặc command
* `ps aux –sort=-pcpu,+pmem` – Hiển thị process đang dùng nhiều tài nguyên nhất của CPU.
* `ps -e -o pid,uname,pcpu,pmem,comm` – Được dùng để lọc column được chỉ định.
* `ps -e -o pid,comm,etime` – Việc này sẽ hiển thị thời gian đã được dùng của process.

Thêm một chút về [quản lý tiến trình](https://studylinux.wordpress.com/2012/03/02/10-cau-l%E1%BB%87nh-d%E1%BB%83-qu%E1%BA%A3n-ly-ti%E1%BA%BFn-trinh-tren-linux-b%E1%BA%B1ng-terminal/)

Dừng tiến trình

	kill <pid>
    hoặc
    killall <pname>

Nếu tiến trình này quá cứng đầu thì hay sử dụng `kill -p <pid>`



### Command top

Lệnh `top` hiển thị các thông tin để có thể giám sát các thông số CPU, RAM,... các tiến trình đang hoặt động trên hệ thống

```sh
top - 09:28:52 up 154 days, 23:04,  2 users,  load average: 0.00, 0.00, 0.00
Tasks: 113 total,   1 running, 112 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.3 us,  0.0 sy,  0.0 ni, 99.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  1014648 total,   204156 free,    65596 used,   744896 buff/cache
KiB Swap:        0 total,        0 free,        0 used.   727912 avail Mem 

  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND                        
    1 root      20   0  185436   5344   3272 S  0.0  0.5   0:42.19 systemd                        
    2 root      20   0       0      0      0 S  0.0  0.0   0:00.00 kthreadd                       
    3 root      20   0       0      0      0 S  0.0  0.0   0:16.85 ksoftirqd/0                    
    5 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:0H                   
    7 root      20   0       0      0      0 S  0.0  0.0   0:10.29 rcu_sched                      
    8 root      20   0       0      0      0 S  0.0  0.0   0:00.00 rcu_bh  
```

Command `pstree` hiển thị các tiến trình đang chạy trên hệ thống dưới dạng một sơ đồ cây thể hiện mối quan hệ của các tiến trình con và tiến trình cha cùng toàn bộ các tiến trình khác mà nó tạo ra. Các luồng được thể hiện bằng dấu ngoặc nhọn

```sh
$ pstree
systemd─┬─accounts-daemon─┬─{gdbus}
        │                 └─{gmain}
        ├─acpid
        ├─2*[agetty]
        ├─atd
        ├─cron
        ├─dbus-daemon
        ├─2*[dhclient]
        ├─2*[iscsid]
        ├─lvmetad
        ├─lxcfs───10*[{lxcfs}]
        ├─mdadm
        ├─polkitd─┬─{gdbus}
        │         └─{gmain}
        ├─rsyslogd─┬─{in:imklog}
        │          ├─{in:imuxsock}
        │          └─{rs:main Q:Reg}
        ├─snapd───6*[{snapd}]
        ├─sshd─┬─sshd───sshd───bash───pstree
        │      └─sshd───sshd───bash───sudo───bash───su───bash
        ├─systemd───(sd-pam)
        ├─systemd-journal
        ├─systemd-logind
        └─systemd-udevd
```

### Scheduling processes

Lệnh `at` được sử dụng để thực thi 1 chương trình được chỉ định thời gian cụ thể, cần cài đặt `atd` để sử dụng. Trên Ubuntu 16 đã được cài đặt mặc định.

Lệnh `atq`  được sử dụng để liệt kê danh sách các job đang được đặt lịch bởi command `at`

Tiền ích `cron` là một chương trình lập lịch dựa trên thời gian. Cron được định hướng bởi một file câu hính là `/etc/crontab` chưa các lệnh shell khác nhau cần chạy vào đứng thời điểm đã được lên lịch. Mỗi dòng trong file này đại diện cho một công việc. Lệnh `crontab -e` sẽ mở crontab editor để chỉnh sửa hoặc thêm các jobs mới. Mỗi dòng sẽ gồm 6 dòng.

* MIN minutes 0-59
* HOUR Hour field 0-23
* DOM Day of month 1-31
* MON	Month field	1-12
* DOW	Day Of Week	0-6 (0 = Sunday)
* CMD	Command	bất kỳ một command nào được thực thi

Ví dụ 

	* * * * * /usr/local/bin/execute/this/script.sh

Lệnh trên nghĩa là thực hiện lệnh mỗi phút một lần.

	30 08 10 06 * /home/sysadmin/full-backup

sẽ đặt lịch cho full-backup lúc 8h30 ngày 10 tháng 6 không quan tâm là ngày nào trong tuần

### Delaying processes

Khi có một công việc nào đó cần trì hoãn hoặc tạm dùng thì ta có thể sử dụng lệnh `sleep` sẽ dùng lệnh thực thi trong một thời gian cụ thể rồi chạy tiếp.

```sh
$ cat script.sh
#!/bin/bash
echo "The system will go to sleep fo 30 seconds ..."
sleep 15
echo "The system is awaked"
$ chmod u+x script.sh
$ ./script.sh
The system will go to sleep fo 30 seconds ...
The system is awaked
```

Tổng quan về sự chuyển đổi giữa các tiến trình

<img src = "img/1.png">
